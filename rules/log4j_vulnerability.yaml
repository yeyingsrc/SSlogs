name: Log4j远程代码执行漏洞 (Log4Shell)
pattern:
  # Log4j JNDI注入特征
  params: '(\$|%\{24\})\{.*?(jndi|ldap|rmi|dns|iiop|corba)\s*:.*?\}'

  # 各种JNDI协议变体
  params: '\$\{.*?(jndi:ldap|jndi:rmi|jndi:dns|jndi:iiop|jndi:corba).*?\}'

  # 绕过和编码变体
  params: '\$\{.*?(lower|upper|upper|lower)\s*:\s*jndi.*?\}'
  params: '\$\{.*?(env|sys|java)\s*:.*?\}'
  decoded_params: '(\$|%24|%2524).*?\{.*?(jndi|ldap|rmi|dns).*?\}'

  # Log4j 2.x 通用模式
  params: '\$\{.*?\}.*?(com\.sun\.jndi|javax\.naming|org\.apache\.logging)'

  # 其他常见JNDI注入载荷
  params: '(jndi:ldap|jndi:rmi)://.*?/[a-zA-Z0-9]*\.(class|jar|exe|sh)'

  # 反序列化和类加载
  params: '\$\{.*?(java|class|loader|object|serial).*?\}'

severity: critical
category: rce
description: |
  检测Log4j远程代码执行漏洞 (CVE-2021-44228, Log4Shell)：
  - JNDI注入攻击
  - LDAP/RMI协议利用
  - 绕过技术检测
  - 反序列化攻击

  漏洞详情：
  - CVE-2021-44228: Log4j 2.14.1及以下版本
  - CVE-2021-45046: Log4j 2.15.0版本DoS
  - CVE-2021-44832: Log4j 2.16.0版本RCE

  攻击特征：
  - ${jndi:ldap://} 模式
  - 绕过技术: ${lower:jndi}
  - 编码变体: %24%7Bjndi
cwe: "CWE-502"
references:
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-44228"
  - "https://logging.apache.org/log4j/2.x/security.html"
  - "https://www.lunasec.io/docs/blog/log4j-zero-day/"
attack_patterns:
  - "JNDI注入"
  - "远程类加载"
  - "反序列化攻击"
  - "RCE利用链"
response_codes: [200, 400, 500]
threat_level: "critical"
impact: "可能导致服务器完全控制、数据窃取或横向渗透"