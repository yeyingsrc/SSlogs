name: 文件上传漏洞检测
pattern:
  # 危险文件扩展名
  params: '\.(php|phtml|php3|php4|php5|php7|php8|jsp|jspx|asp|aspx|cgi|pl|py|rb|sh|bat|cmd|exe|com|scr|vbs|js|jar|war|ear)'

  # WebShell特征
  params: '(webshell|backdoor|c99|r57|wso|b374k|冰蝎|哥斯拉|菜刀|一句话木马|eval|assert|system|shell_exec|passthru)'

  # 文件名注入
  params: 'filename=.*?(\.php|\.jsp|\.asp|\.cgi|\.py|\.sh|\.bat|\.exe|\.cmd)'

  # MIME类型绕过
  request_headers: '(Content-Type|Content-Disposition):.*?(application/octet-stream|image/jpeg|image/png|text/plain).*?(\.php|\.jsp|\.asp)'

  # 双重扩展名
  params: '\.(jpg|png|gif|pdf|txt|doc|xls)\.(php|jsp|asp|cgi|py)'

  # 大小写绕过
  params: '\.(PHP|JSP|ASP|CGI|PY|SH|BAT|EXE|CMD)'

  # 空字节和特殊字符绕过
  params: '\.(php|jsp|asp|cgi)[\x00-\x1F]'

  # 路径遍历结合文件上传
  params: '\.\./.*?\.(php|jsp|asp|cgi|py|sh|bat)'

  # 文件内容检测
  request_body: '(<\?php|<%@|<script|<%!\[CDATA\[|#!/bin/bash|#!/usr/bin/python|eval\s*\(|system\s*\()'

  # 压缩包文件
  params: '\.(zip|rar|tar|gz|7z)'

  # 压缩包内危险文件
  request_body: '(PK\x03\x04|PK\x05\x06|PK\x07\x08).*?(\.php|\.jsp|\.asp|\.cgi)'

  # 临时文件
  params: '/(tmp|temp|temporary|upload)/.*?\.(php|jsp|asp|cgi)'

  # 执行权限
  params: '(chmod\s+777|chown|\.exe|\.bat|\.sh|\.cmd)'

  # 文件大小绕过
  request_headers: '(Content-Length):[0-9]+.*?(\.\.\.|000000)'

  # 文件名编码
  decoded_params: 'filename=.*?(%2E%70%68%70|%2E%6A%73%70|%2E%61%73%70)'

  # 上传目录探测
  request_path: '/(upload|uploads|files|attachments|documents|media|temp|tmp)/'

  # 批量上传
  params: '(file|files|upload|attachment)\[\d+\]'

severity: high
category: file_upload
description: |
  文件上传漏洞检测，识别多种攻击向量：
  - 危险文件类型上传(PHP/JSP/ASP/CGI等)
  - WebShell后门上传检测
  - 文件名注入和路径遍历
  - MIME类型和扩展名绕过
  - 双重扩展名和编码绕过
  - 压缩包内危险文件检测
  - 临时文件和执行权限
  - 批量上传攻击
  - 文件内容恶意代码检测

cwe: "CWE-434"
references:
  - "https://owasp.org/www-project-top-ten/2017/A1_2017-Injection"
  - "https://www.owasp.org/index.php/Unrestricted_File_Upload"
attack_patterns:
  - "文件上传"
  - "WebShell"
  - "代码执行"
  - "权限提升"
  - "路径遍历"
response_codes: [200, 201, 403, 404, 500]
threat_level: "high"
impact: "可能导致远程代码执行、系统控制或数据泄露"