name: 威胁情报自动检测与IOC匹配
pattern:
  # 恶意IP地址检测
  src_ip: '(1[0-9]{2}|20[0-9]|21[0-9])\.\d+\.\d+\.\d+|(192\.168\.\d+\.\d+|10\.\d+\.\d+\.\d+|172\.1[6-9]\.\d+\.\d+|172\.2[0-9]\.\d+\.\d+|172\.3[0-1]\.\d+\.\d+)|(0\.0\.0\.0|127\.0\.0\.1|255\.255\.255\.255)'

  # 恶意域名检测
  request_path: '.*(phishing|malware|botnet|c2|command).*\.(com|net|org|info|biz|ru|cn|tk|ml)|.*(0-9a-f]{32,64})\.(com|net|org|info)|.*(tk|ml|ga|cf|men|gq)'

  # 恶意文件哈希检测
  params:
    # 恶意软件哈希
    '(hash|md5|sha1|sha256)=.*?[a-fA-F0-9]{32,64}'
    '(file|download|document)=.*?[a-fA-F0-9]{32,64}'
    '(signature|checksum)=.*?[a-fA-F0-9]{32,64}'

  # 恶意URL模式
  request_path:
    # 恶意URL结构
    '.*\/(malware|virus|trojan|backdoor|exploit|payload)\/.*'
    '.*\/(bot|c2|command|control|beacon)\/.*'
    '.*\/(shell|webshell|backdoor|cmd)\/.*'

  # 恶意User-Agent检测
  user_agent:
    # 已知攻击工具
    '(sqlmap|nmap|nikto|dirb|gobuster|burp|metasploit|nessus)'
    '(python-requests|curl|wget|powershell|cmd\.exe|bash|sh)'
    '(bot|crawler|spider|scraper|harvester|extractor)'

  # APT组织指纹
  user_agent:
    # APT工具特征
    '(APT|Lazarus|Fancy Bear|Cozy Bear|Equation Group)'
    '(Stuxnet|Flame|Duqu|Gauss|RedLeaves|PlugX)'
    '(Cobalt Strike|Beacon|Empire|PoshC2|Metasploit)'

  # 命令与控制通信
  request_headers:
    # C2通信特征
    '(X-Command|X-Control|X-Beacon|X-C2):'
    '(X-Task|X-Job|X-Update|X-Config):'
    '(User-Agent):\s*(Mozilla/5\.0 \(compatible;.*bot.*\)|.*curl.*|.*wget.*)'

  # 威胁情报标签
  request_body:
    # IOC标记
    '{"(ioc|threat|malicious|evil|bad)":\s*"(true|1|yes)"}'
    '{"(confidence|severity|risk)":\s*"(high|critical|dangerous)"}'
    '{"(source|provider|feed)":\s*"(threat.*intel|misp|alienvault|virustotal)"}'

  # 地缘政治威胁
  request_headers:
    # 高风险地区
    '(X-Country|X-Region|X-GeoIP):\s*(KP|IR|RU|CN|SY|AF|PK|BD)'
    '(X-ASN|X-Network):\s*(AS\d+)'  # 已知恶意ASN

  # 恶意证书检测
  request_headers:
    # 异常证书
    '(X-SSL|X-Certificate|X-TLS):.*?(expired|invalid|self-signed|malicious)'

severity: critical
category: threat_intelligence
description: |
  集成威胁情报的自动检测规则，实时匹配IOC（威胁指标）：

  **IOC威胁指标匹配**：
  - 恶意IP地址和网段
  - 恶意域名和DGA域名
  - 恶意软件文件哈希
  - 恶意URL和路径模式

  **攻击工具指纹识别**：
  - 已知攻击工具User-Agent
  - 自动化扫描器识别
  - 恶意脚本和工具特征
  - 渗透测试框架检测

  **APT组织特征检测**：
  - APT组织工具指纹
  - 高级持续性威胁指标
  - 地缘政治相关威胁
  - 国家级攻击特征

  **命令控制通信检测**：
  - C2服务器通信模式
  - 恶意网络连接特征
  - 异常通信协议检测
  - 隐蔽隧道识别

  **威胁情报集成**：
  - 实时IOC数据源匹配
  - 威胁情报标签识别
  - 风险评分和置信度
  - 自动化威胁分类

cwe: "CWE-20"
references:
  - "https://attack.mitre.org/"
  - "https://misp-project.org/"
  - "https://www.virustotal.com/"
  - "https://otx.alienvault.com/"
attack_patterns:
  - "恶意软件传播"
  - "C2通信"
  - "APT攻击"
  - "僵尸网络控制"
response_codes: [200, 201, 301, 302, 400, 401, 403, 404, 500, 502]
threat_level: "critical"
impact: "直接关联已知威胁，可能表示正在进行的攻击活动"

# 威胁情报配置
threat_intel_config:
  enable_real_time_updates: true
  sources:
    - "MISP"
    - "AlienVault OTX"
    - "VirusTotal"
    - "AbuseIPDB"
    - "ThreatFox"
  update_interval: 300  # 5分钟更新一次

# IOC匹配配置
ioc_matching:
  ip_reputation: true
  domain_reputation: true
  hash_reputation: true
  url_reputation: true
  asn_reputation: true

# 评分系统
scoring:
  ioc_confidence_weight: 0.4
  historical_data_weight: 0.3
  context_analysis_weight: 0.3

# 白名单配置
whitelist:
  internal_networks:
    - "192.168.0.0/16"
    - "10.0.0.0/8"
    - "172.16.0.0/12"
  trusted_domains:
    - "google.com"
    - "microsoft.com"
    - "apple.com"