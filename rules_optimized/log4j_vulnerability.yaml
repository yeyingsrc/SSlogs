name: Log4j/LogShell漏洞检测
pattern:
  # Log4j JNDI注入检测
  params: '\$\{(jndi|lower|upper):\w+://\w+'
  params: '\$\{env:\w+\}'
  params: '\$\{sys:\w+\}'
  params: '\$\{java:\w+\}'
  params: '\$\{spring:\w+\}'
  params: '\$\{main:\w+\}'
  params: '\$\{k8s:\w+\}'
  params: '\$\{docker:\w+\}'
  params: '\$\{aws:\w+\}'
  params: '\$\{gc:\w+\}'
  params: '\$\{date:.*?\}'
  params: '\$\{ctx:.*?\}'
  params: '\$\{map:.*?\}'
  params: '\$\{bundle:.*?\}'

  # 绕过检测
  params: '\$\{[^}]*\$\{[^}]*\}.*?\}'
  params: '\$\{[^}]*:-.*?\}'
  params: '\$\{[^}]*:.*?@\w+://\w+'

  # 常见JNDI服务
  params: '(rmi|ldap|corba|dns|iiop)://[^/]+/[^\s]*'
  params: '://[a-z0-9\.-]+\.com/[^\s]*'
  params: '://[a-z0-9\.-]+\.org/[^\s]*'
  params: '://[a-z0-9\.-]+\.net/[^\s]*'

severity: critical
category: vulnerability
description: |
  检测Log4j远程代码执行漏洞(CVE-2021-44228)利用尝试，包括：
  - JNDI注入攻击
  - LDAP/RMI服务利用
  - 环境变量泄露
  - 绕过技术检测

  支持检测的Log4j变体：
  - 原始漏洞 (CVE-2021-44228)
  - 绕过补丁的变种
  - 环境变量泄露
  - 上下文信息泄露
cwe: "CWE-502"
references:
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-44228"
  - "https://www.lunasec.io/docs/blog/log4j-zero-day/"
  - "https://logging.apache.org/log4j/2.x/security.html"
attack_patterns:
  - "远程代码执行"
  - "JNDI注入"
  - "环境变量泄露"
  - "服务信息泄露"
response_codes: [200, 400, 500]
threat_level: "critical"
impact: "可能导致服务器完全被控制，造成数据泄露和系统破坏"