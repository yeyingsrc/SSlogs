name: 服务器端请求伪造(SSRF)检测 (增强版)
pattern:
  # 内网IP地址检测 (覆盖更全面)
  url: '(https?://)(localhost|127\.0\.0\.1|0\.0\.0\.0|::1|0000:0000:0000:0000:0000:0000:0000:0001|192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3}|169\.254\.\d{1,3}\.\d{1,3})'

  # 元数据服务检测
  params: '(metadata|169\.254\.169\.254|100\.100\.100\.200|metadata\.google\.internal|169\.254\.169\.254/latest)'

  # DNS重绑定和绕过技术
  url: '(https?://)[a-z0-9\-\.]+\.(local|internal|localhost|lan|home|corp)(:\d+)?'

  # 端口扫描检测
  params: '(port|host|url|target|ip)=.*(:80|:443|:8080|:3000|:8000|:9000|:3306|:5432|:6379|:27017|:11211|:22|:21|:23|:25|:53)'

  # URL编码绕过检测
  decoded_params: '(127%2E|192%2E|10%2E|172%2E|localhost|%2F%2F|169%2E254%2E169%2E254)'

severity: critical
category: ssrf
description: |
  检测服务器端请求伪造攻击，包括：
  - 内网IP地址访问
  - 云服务元数据查询
  - DNS重绑定攻击
  - 端口扫描尝试
  - URL编码绕过

  增强功能：
  - 覆盖IPv6本地地址
  - 检测链路本地地址
  - 识别云平台元数据服务
  - 防御编码绕过
cwe: "CWE-918"
references:
  - "https://owasp.org/www-community/attacks/Server_Side_Request_Forgery"
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://portswigger.net/web-security/ssrf"
attack_patterns:
  - "内网探测"
  - "云服务凭证窃取"
  - "端口扫描"
  - "服务指纹识别"
response_codes: [200, 202, 404, 500, 502]
threat_level: "critical"
impact: "可能导致内网渗透、云服务凭证泄露或内部系统访问"